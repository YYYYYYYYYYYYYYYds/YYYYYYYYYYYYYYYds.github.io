<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LPStake æˆæƒç®¡ç†</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <div class="container">
        <div class="card">
            <h1 class="title">ğŸ” LPStake æˆæƒç®¡ç†</h1>
            
            <!-- ç½‘ç»œä¿¡æ¯ -->
            <div class="network-info" id="networkInfo">
                <span id="networkName">æœªè¿æ¥</span> | 
                <span id="userAddress">æœªè¿æ¥é’±åŒ…</span>
            </div>

            <!-- è¿æ¥é’±åŒ…æŒ‰é’® -->
            <button class="button button-primary" id="connectBtn" onclick="connectWallet()">
                è¿æ¥é’±åŒ…
            </button>

            <!-- åˆçº¦åœ°å€è¾“å…¥ -->
            <!-- <div class="info-section" style="margin-top: 20px;">
                <div class="info-label">LPStake åˆçº¦åœ°å€</div>
                <input type="text" class="info-value" id="contractAddress" 
                       placeholder="è¾“å…¥ LPStake åˆçº¦åœ°å€..."
                       style="cursor: text; border: 2px solid #e2e8f0;">
                <button class="button button-secondary" style="margin-top: 10px;" onclick="loadContractInfo()">
                    åŠ è½½åˆçº¦ä¿¡æ¯
                </button>
            </div> -->

            <div id="contractInfo" class="hidden">
                <!-- é’±åŒ…åœ°å€ä¿¡æ¯ -->
                <div class="info-section">
                    <!-- <h3 style="margin: 20px 0 15px; color: #2d3748; font-size: 18px;">ğŸ“ å…³é”®åœ°å€</h3> -->
                    
                    <div style="margin-bottom: 15px;">
                        <div class="info-label">LPä¿é™©ç®±</div>
                        <div class="info-value" id="lpVaultAddress">-</div>
                    </div>

                    <div style="margin-bottom: 15px;">
                        <div class="info-label">ç¤¾åŒºé’±åŒ…åœ°å€</div>
                        <div class="info-value" id="communityWalletAddress">-</div>
                    </div>

                    <div style="margin-bottom: 15px;">
                        <div class="info-label">HDç™½åå•åœ°å€</div>
                        <div class="info-value" id="excludeFromHdFeeAddress">-</div>
                    </div>

                    <div style="margin-bottom: 15px;">
                        <div class="info-label">é»˜è®¤é‚€è¯·è€…åœ°å€</div>
                        <div class="info-value" id="defaultInviter">-</div>
                    </div>
                </div>

                <!-- æˆæƒçŠ¶æ€ -->
                <div class="info-section">
                    <h3 style="margin: 20px 0 15px; color: #2d3748; font-size: 18px;">æˆæƒçŠ¶æ€</h3>

                    <!-- æˆæƒ 1: lpVaultAddress -> USDT -->
                    <div class="auth-item" style="background: #f7fafc; padding: 15px; border-radius: 12px; margin-bottom: 15px;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                            <div>
                                <div style="font-weight: 600; color: #2d3748;">LP Vault â†’ USDT</div>
                                <div style="font-size: 12px; color: #666; margin-top: 4px;">æˆæƒç»™ LPStake åˆçº¦</div>
                            </div>
                            <span class="status-badge" id="status1">æ£€æŸ¥ä¸­...</span>
                        </div>
                        <button class="button button-primary" id="authBtn1" onclick="authorize(1)" disabled>
                            æˆæƒ
                        </button>
                    </div>

                    <!-- æˆæƒ 2: lpVaultAddress -> HDLP -->
                    <div class="auth-item" style="background: #f7fafc; padding: 15px; border-radius: 12px; margin-bottom: 15px;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                            <div>
                                <div style="font-weight: 600; color: #2d3748;">LP Vault â†’ HDLP</div>
                                <div style="font-size: 12px; color: #666; margin-top: 4px;">æˆæƒç»™ LPStake åˆçº¦</div>
                            </div>
                            <span class="status-badge" id="status2">æ£€æŸ¥ä¸­...</span>
                        </div>
                        <button class="button button-primary" id="authBtn2" onclick="authorize(2)" disabled>
                            æˆæƒ
                        </button>
                    </div>

                    <!-- æˆæƒ 3: communityWalletAddress -> USDT -->
                    <div class="auth-item" style="background: #f7fafc; padding: 15px; border-radius: 12px; margin-bottom: 15px;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                            <div>
                                <div style="font-weight: 600; color: #2d3748;">Community Wallet â†’ USDT</div>
                                <div style="font-size: 12px; color: #666; margin-top: 4px;">æˆæƒç»™ LPStake åˆçº¦</div>
                            </div>
                            <span class="status-badge" id="status3">æ£€æŸ¥ä¸­...</span>
                        </div>
                        <button class="button button-primary" id="authBtn3" onclick="authorize(3)" disabled>
                            æˆæƒ
                        </button>
                    </div>

                    <!-- æˆæƒ 4: excludeFromHdFeeAddress -> HD -->
                    <div class="auth-item" style="background: #f7fafc; padding: 15px; border-radius: 12px; margin-bottom: 15px;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                            <div>
                                <div style="font-weight: 600; color: #2d3748;">Exclude Address â†’ HD</div>
                                <div style="font-size: 12px; color: #666; margin-top: 4px;">æˆæƒç»™ LPStake åˆçº¦</div>
                            </div>
                            <span class="status-badge" id="status4">æ£€æŸ¥ä¸­...</span>
                        </div>
                        <button class="button button-primary" id="authBtn4" onclick="authorize(4)" disabled>
                            æˆæƒ
                        </button>
                    </div>
                </div>

                <!-- åˆ·æ–°æŒ‰é’® -->
                <button class="button button-secondary" onclick="loadContractInfo()" style="margin-top: 20px;">
                    ğŸ”„ åˆ·æ–°æˆæƒçŠ¶æ€
                </button>
            </div>

            <!-- æ¶ˆæ¯æç¤º -->
            <div id="messageBox"></div>
        </div>
    </div>

    <script src="web3.min.js"></script>
    <script>
        let web3;
        let lpStakeContract;
        let currentAccount;
        let contractAddress;
        
        // åˆçº¦æ•°æ®
        let contractData = {
            lpVaultAddress: '',
            communityWalletAddress: '',
            excludeFromHdFeeAddress: '',
            defaultInviter: '',
            usdtToken: '',
            hdLpAddress: '',
            hdAddress: '',
            allowances: {}
        };

        // LPStake ABIï¼ˆåªéœ€è¦ç”¨åˆ°çš„å‡½æ•°ï¼‰
        const LP_STAKE_ABI = [
            {
                "inputs": [],
                "name": "getAllWalletsAndAllowances",
                "outputs": [
                    {"internalType": "address", "name": "_lpVaultAddress", "type": "address"},
                    {"internalType": "address", "name": "_communityWalletAddress", "type": "address"},
                    {"internalType": "address", "name": "_excludeFromHdFeeAddress", "type": "address"},
                    {"internalType": "address", "name": "_defaultInviter", "type": "address"},
                    {"internalType": "address", "name": "_dividendTrackerUSDT", "type": "address"},
                    {"internalType": "address", "name": "_dividendTrackerSonOfHDLp", "type": "address"},
                    {"internalType": "uint256", "name": "lpVaultAddress_this_USDT_allowance", "type": "uint256"},
                    {"internalType": "uint256", "name": "lpVaultAddress_this_HDLP_allowance", "type": "uint256"},
                    {"internalType": "uint256", "name": "communityWalletAddress_this_USDT_allowance", "type": "uint256"},
                    {"internalType": "uint256", "name": "excludeFromHdFeeAddress_this_HD_allowance", "type": "uint256"}
                ],
                "stateMutability": "view",
                "type": "function"
            },
            {
                "inputs": [],
                "name": "usdtToken",
                "outputs": [{"internalType": "address", "name": "", "type": "address"}],
                "stateMutability": "view",
                "type": "function"
            },
            {
                "inputs": [],
                "name": "hdLpAddress",
                "outputs": [{"internalType": "address", "name": "", "type": "address"}],
                "stateMutability": "view",
                "type": "function"
            },
            {
                "inputs": [],
                "name": "hdAddress",
                "outputs": [{"internalType": "address", "name": "", "type": "address"}],
                "stateMutability": "view",
                "type": "function"
            }
        ];

        // ERC20 ABIï¼ˆapprove å‡½æ•°ï¼‰
        const ERC20_ABI = [
            {
                "inputs": [
                    {"internalType": "address", "name": "spender", "type": "address"},
                    {"internalType": "uint256", "name": "amount", "type": "uint256"}
                ],
                "name": "approve",
                "outputs": [{"internalType": "bool", "name": "", "type": "bool"}],
                "stateMutability": "nonpayable",
                "type": "function"
            }
        ];

        // è¿æ¥é’±åŒ…
        async function connectWallet() {
            try {
                if (typeof window.ethereum === 'undefined') {
                    showMessage('è¯·å®‰è£… MetaMask é’±åŒ…ï¼', 'error');
                    return;
                }

                const accounts = await window.ethereum.request({ method: 'eth_requestAccounts' });
                currentAccount = accounts[0];
                
                web3 = new Web3(window.ethereum);
                
                // è·å–ç½‘ç»œä¿¡æ¯
                const chainId = await web3.eth.getChainId();
                const networkName = getNetworkName(chainId);
                
                document.getElementById('networkName').textContent = networkName;
                document.getElementById('userAddress').textContent = formatAddress(currentAccount);
                document.getElementById('connectBtn').textContent = 'âœ… å·²è¿æ¥';
                document.getElementById('connectBtn').disabled = true;
                
                await loadContractInfo();
                showMessage('é’±åŒ…è¿æ¥æˆåŠŸï¼', 'success');
                
                // ç›‘å¬è´¦æˆ·å˜åŒ–
                window.ethereum.on('accountsChanged', (accounts) => {
                    location.reload();
                });
                
                // ç›‘å¬ç½‘ç»œå˜åŒ–
                window.ethereum.on('chainChanged', () => {
                    location.reload();
                });
                
            } catch (error) {
                console.error(error);
                showMessage('è¿æ¥é’±åŒ…å¤±è´¥: ' + error.message, 'error');
            }
        }

        // åŠ è½½åˆçº¦ä¿¡æ¯
        async function loadContractInfo() {
            try {
                if (!web3) {
                    showMessage('è¯·å…ˆè¿æ¥é’±åŒ…ï¼', 'error');
                    return;
                }

                contractAddress = '0xddA1c0B9595d0af2357F70DaECf8110CCC084aED';
                showMessage('æ­£åœ¨åŠ è½½åˆçº¦ä¿¡æ¯...', 'info');

                // åˆ›å»ºåˆçº¦å®ä¾‹
                lpStakeContract = new web3.eth.Contract(LP_STAKE_ABI, contractAddress);

                // è·å–æ‰€æœ‰ä¿¡æ¯
                const result = await lpStakeContract.methods.getAllWalletsAndAllowances().call();
                
                // ä¿å­˜æ•°æ®
                contractData.lpVaultAddress = result._lpVaultAddress;
                contractData.communityWalletAddress = result._communityWalletAddress;
                contractData.excludeFromHdFeeAddress = result._excludeFromHdFeeAddress;
                contractData.defaultInviter = result._defaultInviter;
                
                contractData.allowances = {
                    vault_usdt: result.lpVaultAddress_this_USDT_allowance,
                    vault_hdlp: result.lpVaultAddress_this_HDLP_allowance,
                    community_usdt: result.communityWalletAddress_this_USDT_allowance,
                    exclude_hd: result.excludeFromHdFeeAddress_this_HD_allowance
                };

                // è·å–ä»£å¸åœ°å€
                contractData.usdtToken = await lpStakeContract.methods.usdtToken().call();
                contractData.hdLpAddress = await lpStakeContract.methods.hdLpAddress().call();
                contractData.hdAddress = await lpStakeContract.methods.hdAddress().call();

                // æ˜¾ç¤ºä¿¡æ¯
                displayContractInfo();
                updateAuthorizationStatus();
                
                document.getElementById('contractInfo').classList.remove('hidden');
                showMessage('åˆçº¦ä¿¡æ¯åŠ è½½æˆåŠŸï¼', 'success');

            } catch (error) {
                console.error(error);
                showMessage('åŠ è½½å¤±è´¥: ' + error.message, 'error');
            }
        }

        // æ˜¾ç¤ºåˆçº¦ä¿¡æ¯
        function displayContractInfo() {
            document.getElementById('lpVaultAddress').textContent = contractData.lpVaultAddress;
            document.getElementById('communityWalletAddress').textContent = contractData.communityWalletAddress;
            document.getElementById('excludeFromHdFeeAddress').textContent = contractData.excludeFromHdFeeAddress;
            document.getElementById('defaultInviter').textContent = contractData.defaultInviter;
        }

        // æ›´æ–°æˆæƒçŠ¶æ€
        function updateAuthorizationStatus() {
            const LARGE_AMOUNT = web3.utils.toBN('1000000000000000000000000'); // 10^24

            // æ£€æŸ¥å„ä¸ªæˆæƒçŠ¶æ€
            updateStatus(1, contractData.allowances.vault_usdt, LARGE_AMOUNT, contractData.lpVaultAddress);
            updateStatus(2, contractData.allowances.vault_hdlp, LARGE_AMOUNT, contractData.lpVaultAddress);
            updateStatus(3, contractData.allowances.community_usdt, LARGE_AMOUNT, contractData.communityWalletAddress);
            updateStatus(4, contractData.allowances.exclude_hd, LARGE_AMOUNT, contractData.excludeFromHdFeeAddress);
        }

        // æ›´æ–°å•ä¸ªæˆæƒçŠ¶æ€
        function updateStatus(index, allowance, threshold, walletAddress) {
            const statusEl = document.getElementById(`status${index}`);
            const btnEl = document.getElementById(`authBtn${index}`);
            
            const allowanceBN = web3.utils.toBN(allowance);
            const isAuthorized = allowanceBN.gte(threshold);

            if (isAuthorized) {
                statusEl.textContent = 'âœ… å·²æˆæƒ';
                statusEl.className = 'status-badge status-authorized';
                btnEl.disabled = true;
                btnEl.textContent = 'å·²æˆæƒ';
            } else {
                statusEl.textContent = 'âŒ æœªæˆæƒ';
                statusEl.className = 'status-badge status-unauthorized';
                
                // æ£€æŸ¥å½“å‰è´¦æˆ·æ˜¯å¦æ˜¯éœ€è¦æˆæƒçš„åœ°å€
                if (currentAccount && currentAccount.toLowerCase() === walletAddress.toLowerCase()) {
                    btnEl.disabled = false;
                    btnEl.textContent = 'ç«‹å³æˆæƒ';
                } else {
                    btnEl.disabled = true;
                    btnEl.textContent = 'è¯·åˆ‡æ¢åˆ°å¯¹åº”åœ°å€';
                }
            }
        }

        // æ‰§è¡Œæˆæƒ
        async function authorize(index) {
            try {
                const btn = document.getElementById(`authBtn${index}`);
                btn.disabled = true;
                btn.innerHTML = '<span class="loading"></span>å¤„ç†ä¸­...';

                let tokenAddress, fromAddress;
                
                // ç¡®å®šæˆæƒçš„ä»£å¸å’Œåœ°å€
                switch(index) {
                    case 1: // lpVaultAddress -> USDT
                        tokenAddress = contractData.usdtToken;
                        fromAddress = contractData.lpVaultAddress;
                        break;
                    case 2: // lpVaultAddress -> HDLP
                        tokenAddress = contractData.hdLpAddress;
                        fromAddress = contractData.lpVaultAddress;
                        break;
                    case 3: // communityWalletAddress -> USDT
                        tokenAddress = contractData.usdtToken;
                        fromAddress = contractData.communityWalletAddress;
                        break;
                    case 4: // excludeFromHdFeeAddress -> HD
                        tokenAddress = contractData.hdAddress;
                        fromAddress = contractData.excludeFromHdFeeAddress;
                        break;
                }

                // éªŒè¯å½“å‰è´¦æˆ·
                if (currentAccount.toLowerCase() !== fromAddress.toLowerCase()) {
                    showMessage('è¯·åˆ‡æ¢åˆ°æ­£ç¡®çš„é’±åŒ…åœ°å€ï¼š' + formatAddress(fromAddress), 'error');
                    btn.disabled = false;
                    btn.textContent = 'ç«‹å³æˆæƒ';
                    return;
                }

                // åˆ›å»º Token åˆçº¦å®ä¾‹
                const tokenContract = new web3.eth.Contract(ERC20_ABI, tokenAddress);

                // æˆæƒæœ€å¤§å€¼
                const maxAmount = '0xffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff';
                
                showMessage('è¯·åœ¨é’±åŒ…ä¸­ç¡®è®¤æˆæƒäº¤æ˜“...', 'info');

                // æ‰§è¡Œæˆæƒ
                const tx = await tokenContract.methods.approve(contractAddress, maxAmount).send({
                    from: currentAccount
                });

                showMessage('âœ… æˆæƒæˆåŠŸï¼äº¤æ˜“å“ˆå¸Œ: ' + tx.transactionHash.substring(0, 10) + '...', 'success');

                // å»¶è¿Ÿåˆ·æ–°çŠ¶æ€
                setTimeout(() => {
                    loadContractInfo();
                }, 2000);

            } catch (error) {
                console.error(error);
                showMessage('æˆæƒå¤±è´¥: ' + (error.message || error), 'error');
                
                const btn = document.getElementById(`authBtn${index}`);
                btn.disabled = false;
                btn.textContent = 'ç«‹å³æˆæƒ';
            }
        }

        // æ˜¾ç¤ºæ¶ˆæ¯
        function showMessage(message, type) {
            const messageBox = document.getElementById('messageBox');
            const className = type === 'error' ? 'error-message' : 
                            type === 'success' ? 'success-message' : 
                            'info-message';
            
            messageBox.innerHTML = `<div class="${className}">${message}</div>`;
            
            // 3ç§’åè‡ªåŠ¨æ¸…é™¤ï¼ˆé™¤äº†é”™è¯¯æ¶ˆæ¯ï¼‰
            if (type !== 'error') {
                setTimeout(() => {
                    messageBox.innerHTML = '';
                }, 3000);
            }
        }

        // æ ¼å¼åŒ–åœ°å€
        function formatAddress(address) {
            if (!address) return '-';
            return address.substring(0, 6) + '...' + address.substring(38);
        }

        // è·å–ç½‘ç»œåç§°
        function getNetworkName(chainId) {
            const networks = {
                1: 'Ethereum Mainnet',
                56: 'BSC Mainnet',
                97: 'BSC Testnet',
                137: 'Polygon',
                31337: 'Localhost'
            };
            return networks[chainId] || `Chain ID: ${chainId}`;
        }

        // é¡µé¢åŠ è½½æ—¶æ£€æŸ¥é’±åŒ…è¿æ¥
        window.addEventListener('load', async () => {
            if (typeof window.ethereum !== 'undefined') {
                const accounts = await window.ethereum.request({ method: 'eth_accounts' });
                if (accounts.length > 0) {
                    connectWallet();
                }
            }
        });
    </script>

    <style>
        .info-message {
            background: #bee3f8;
            color: #2c5282;
            padding: 12px 15px;
            border-radius: 8px;
            margin: 15px 0;
            font-size: 14px;
            text-align: center;
        }
    </style>
</body>
</html>

